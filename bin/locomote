#!/usr/bin/env node

const Usage = `
Usage:

    locomote <command> <options...> <args...>

Where:

    <command> one of the supported or configured commands (see below).

    <options...> is any of the following:

        -h | --help         Print this message and exit.
        -v | --version      Print the version number and exit.
        -E<name>=<value>    Specify a build enviroment name/value.
                            The option can be used multiple times to specify
                            multiple values.
        --config <file>     Specify a configuration file. By default, the
                            command will attempt to load configuration from
                            a file named locomote.build-config.js

    <args...> are positional arguments defined by the command being called.

The standard build commands are:

* serve: Start the development server.

  The dev server will build and serve source code in the current directory.

  Content is built locally and output by default to _site under the current
  location (see 'build' command below).

  Content is served from a local HTTP server which also provides Locomote's
  query API endpoints, and by default listens on port 3000.

  The server will automatically rebuild and serve content as it is modified.

  See locomote-serve for full command line options.

* build: Build source code in the current directory and output to _site.

  The default configuration performs a Heckle static site build followed
  by a webpack build. 

  The default source and target locations can be modifed from the command line:

        locomote build <source> <target>

* deploy: Build the current contents of the 'master' branch and deploy the
  result to the 'test' branch.

  This command performs the same build operations as the 'build' command, but
  works with the contents of the respective git branches rather than the
  filesystem.

  The build is done in a temporary location on the local file system and the
  result is automatically pushed to the remote server.

  The source and target branches can be modified from the command line:

        locomote deploy <source> <target>

* release: Merge the current contents of the 'test' branch into the 'public'
  branch.

  This command can be used to publish previously built content.

  The source and target branches can be modified from the command line:

        locomote release <source> <target>

`;

const Path = require('path');

// Parse the command line.
const argv = require('minimist')( process.argv.slice( 2 ) );

// Extract command line vars.
const {
    v, version,
    h, help,
    config,
    _: [ cname, ...args ]
} = argv;

// Print version?
if( v || version ) {
    printVersion();
    process.exit( 0 );
}

// Print usage?
if( h || help ) {
    printUsage();
    process.exit( 0 );
}

// Command?
if( !cname ) {
    console.log('Build command required');
    printUsage();
    process.exit( 0 );
}

// Default configuration.
let defaultConfig = {
    env: {          // Build environment.
        workspace: '.',
        serverConfig: require('../lib/server/default-config'),
    },
    commands: {}    // Additional build commands.
};

// Load default configuration if none other specified.
if( !config ) {
    defaultConfig = loadConfig( defaultConfig, 'locomote.build-config.js', true );
}
// Else load default configuration.
else {
    [].concat( config )
    .forEach( file => {
        console.log('Loading configuration from %s...', file );
        defaultConfig = loadConfig( defaultConfig, file );
    });
}

// Load command definitions.
let defs = [
    require('../conf/std-build.json'),      // Standard build commands.
    require('../lib/server/build-conf'),    // Dev server build commands.
    defaultConfig.commands                  // Configuration specified commands.
];

// Extract environment assignments from the command line vars.
const env = Object.keys( argv )
    .reduce( ( env, key ) => {
        if( key.startsWith('-E') ) {
            env[key.slice( 2 )] = argv[key];
        }
        return env;
    }, defaultConfig.env );

const { run } = require('../lib');

run('cli:'+cname, env, args, defs )
    .then( () => console.log('Done') )
    .catch( e => console.error( e.message || e ) );

function printVersion() {
    const { version } = require('../package.json');
    console.log('Version: %s', version );
}

function printUsage() {
    console.log('Locomote build tools');
    printVersion();
    console.log( Usage );
}

/**
 * Load configuration from a file.
 */
function loadConfig( baseConfig, file, ignoreNotFound = false ) {
    try {
        const config = require( Path.resolve( file ) );
        return Object.assign( baseConfig, config );
    }
    catch( e ) {
        if( e.code == 'MODULE_NOT_FOUND' && ignoreNotFound ) {
            return baseConfig;
        }
        throw e;
    }
    return baseConfig;
}
